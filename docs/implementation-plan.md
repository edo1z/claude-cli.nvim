# Claude CLI Multi-Instance Manager 実装計画

## 実装フェーズ

### Phase 1: 基本機能実装（完了）

#### 1.1 tmuxセッション管理モジュール (`tmux.lua`)
- [x] tmuxセッションの作成・確認機能
- [x] セッションへのアタッチ機能
- [x] セッション一覧の取得
- [x] セッション状態の確認
- [x] セッションの削除機能
- [x] ウィンドウ名の変更機能

#### 1.2 一覧画面UIモジュール (`ui_list.lua`)
- [x] グリッドレイアウトの計算
- [x] ターミナルバッファの作成・管理
- [x] キーバインディングの設定
- [x] トグル機能の実装
- [x] バッファの再利用によるメモリ効率化

#### 1.3 個別ウィンドウUIモジュール (`ui_individual.lua`)
- [x] 個別ウィンドウの開閉
- [x] アクティブインスタンスの管理
- [x] ウィンドウサイズの調整
- [x] トグル機能の実装
- [x] セッション切り替え機能

#### 1.4 メインマネージャー統合 (`init.lua`)
- [x] 各モジュールの初期化
- [x] コマンドの定義（ClaudeManagerToggle/Show/Hide/Open）
- [x] キーマッピングの設定（`<leader>cm`）
- [x] 既存の`claude-cli`との統合（`<leader>ca`連携）
- [x] UIモジュール間の連携（oキーで個別ウィンドウを開く）

### Phase 2: 動的インスタンス管理（完了）

#### 2.1 基本的な動的管理
- [x] 初期状態を空（0個）に変更
- [x] 動的にインスタンスを追加する機能（`a`キー）
- [x] インスタンスを削除する機能（`d`キー）
- [x] 最大数を30個に拡張

#### 2.2 起動オプション対応
- [x] 起動オプションの選択UI（`a`キーで表示）
- [x] カスタム名での追加（`A`キー）
- [x] 通常起動、継続モード（-c）、危険モード、両方の組み合わせ
- [x] 各インスタンスの起動オプションを記録・表示
- [x] インスタンスの再起動機能（`r`キー）

#### 2.3 UI/UXの改善
- [x] 空の状態での案内表示
- [x] インスタンス情報の表示（番号、状態、起動オプション）
- [x] ヘルプ機能の実装（`?`キー）
- [x] 削除時の確認ダイアログ

### Phase 3: 拡張機能実装

#### 3.1 インスタンス操作の高度化
- [ ] インスタンス名の変更
- [ ] インスタンスの並び替え
- [ ] グループ化機能

#### 2.2 セッション管理強化
- [ ] セッション永続化
- [ ] 自動復元機能
- [ ] セッション状態の保存

#### 2.3 UI/UX改善
- [ ] ステータス表示（アイドル、処理中等）
- [ ] 最終利用時刻の表示
- [ ] カラーテーマのサポート
- [ ] ヘルプ表示

### Phase 3: 最適化と品質向上

#### 3.1 パフォーマンス最適化
- [ ] バッファの効率的な再利用
- [ ] 非同期処理の活用
- [ ] メモリ使用量の最適化

#### 3.2 エラーハンドリング
- [ ] tmuxコマンドエラーの処理
- [ ] 接続エラーからの復旧
- [ ] ユーザーへの適切な通知

#### 3.3 テストとドキュメント
- [ ] ユニットテストの作成
- [ ] 統合テストの作成
- [ ] ユーザーマニュアルの作成
- [ ] APIドキュメントの整備

## Phase 2 実装完了サマリー

### 実装した機能：

#### 1. 状態管理モジュール (state.lua)
- インスタンスの動的管理（追加/削除/取得）
- インスタンス情報の保持（名前、オプション、作成時刻）
- 次に使用可能な番号の自動割り当て
- 最大30インスタンスまでの制限

#### 2. tmux.lua の拡張
- `create_claude_session()`: Claude CLIを指定オプションで起動
- `restart_session()`: セッションの再起動機能
- テスト用のコマンド引数サポート

#### 3. ui_list.lua の完全な再実装
- 初期状態を0インスタンスに変更
- 空状態での案内表示
- `a`キー: 自動番号でインスタンス追加
- `A`キー: カスタム名でインスタンス追加
- `d`キー: インスタンス削除（確認付き）
- `r`キー: インスタンス再起動
- `?`キー: ヘルプ表示
- リフレッシュ機能で画面更新

#### 4. オプション選択モジュール (option_selector.lua)
- 5種類の起動オプションをサポート
  - `n`: オプションなし（デフォルト）
  - `c`: 継続モード (-c)
  - `C`: 継続モード（危険）
  - `d`: 危険モード
  - `D`: 継続＋危険モード
- フローティングウィンドウでの選択
- キー入力による素早い選択

#### 5. init.lua の更新
- マネージャーインスタンスを優先的に使用
- `add_instance()`: インスタンス追加API
- `remove_instance()`: インスタンス削除API
- リストビューと個別ウィンドウの両方からjob_id取得

## 実装上の注意点

1. **既存機能との互換性**
   - 現在の`claude-cli`の機能を壊さない
   - `<leader>ca`との適切な連携

2. **エラーハンドリング**
   - tmuxが利用できない環境での動作
   - セッション作成失敗時の処理

3. **パフォーマンス**
   - 大量のターミナルバッファの効率的な管理
   - 不要なレンダリングの回避

4. **ユーザビリティ**
   - 直感的なキーバインディング
   - 明確なフィードバック

## テスト計画

1. **単体テスト**
   - 各モジュールの個別機能テスト
   - エラーケースのテスト

2. **統合テスト**
   - モジュール間の連携テスト
   - 既存機能との統合テスト

3. **ユーザビリティテスト**
   - 実際の使用シナリオでのテスト
   - パフォーマンステスト

## スケジュール目安

- Phase 1: 2-3日 ✅ **完了（2025年1月4日）**
- Phase 2: 3-4日 ✅ **完了（2025年1月4日）**
- Phase 3: 2-3日 （未実装）

## 実装済み機能のサマリー

### Phase 1で完成した機能：
1. **tmuxベースのマルチインスタンス管理**
   - 最大10個のClaude CLIインスタンスを同時管理
   - 各インスタンスは独立したtmuxセッションで動作

2. **グリッド形式の一覧画面**
   - 新しいタブで全インスタンスをグリッド表示
   - 動的なレイアウト計算（正方形に近い形）
   - トグル機能で表示/非表示の切り替え

3. **個別ウィンドウ管理**
   - 選択したインスタンスを右側の垂直分割で表示
   - アクティブインスタンスの管理と切り替え
   - ウィンドウサイズは画面の40%に自動調整

4. **既存機能との完全な統合**
   - `<leader>ca`でアクティブインスタンスに自動送信
   - 従来の単一インスタンスモードとの互換性維持
   - Vimコマンドによる操作サポート

5. **TDDによる品質保証**
   - 全モジュールにPlenary Bustedによるテスト実装
   - 100%のテストカバレッジ達成

### Phase 2で完成した機能：

1. **完全な動的インスタンス管理**
   - 0個からスタートし、最大30個まで動的に追加/削除
   - 自動番号割り当てとカスタム名の両方をサポート
   - インスタンスごとの起動オプション記録

2. **便利なオプション選択機能**
   - キー入力による素早いオプション選択
   - 継続モード、危険モードの組み合わせ
   - 直感的なフローティングUI

3. **改善されたUI/UX**
   - 空状態での分かりやすい案内
   - 削除時の確認ダイアログ
   - ヘルプ機能によるキーバインディングの説明
   - リアルタイムな画面更新

4. **完全なテストカバレッジ**
   - 全ての新機能にPlenary Bustedテストを実装
   - モックを使用したユニットテスト

### 次のフェーズで実装予定の機能：
- セッション永続化と自動復元
- ステータス表示（アイドル、処理中等）
- インスタンスの並び替えやグループ化