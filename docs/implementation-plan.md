# Claude CLI Multi-Instance Manager 実装計画

## 実装フェーズ

### Phase 1: 基本機能実装（完了）

#### 1.1 tmuxセッション管理モジュール (`tmux.lua`)
- [x] tmuxセッションの作成・確認機能
- [x] セッションへのアタッチ機能
- [x] セッション一覧の取得
- [x] セッション状態の確認
- [x] セッションの削除機能
- [x] ウィンドウ名の変更機能

#### 1.2 一覧画面UIモジュール (`ui_list.lua`)
- [x] グリッドレイアウトの計算
- [x] ターミナルバッファの作成・管理
- [x] キーバインディングの設定
- [x] トグル機能の実装
- [x] バッファの再利用によるメモリ効率化

#### 1.3 個別ウィンドウUIモジュール (`ui_individual.lua`)
- [x] 個別ウィンドウの開閉
- [x] アクティブインスタンスの管理
- [x] ウィンドウサイズの調整
- [x] トグル機能の実装
- [x] セッション切り替え機能

#### 1.4 メインマネージャー統合 (`init.lua`)
- [x] 各モジュールの初期化
- [x] コマンドの定義（ClaudeManagerToggle/Show/Hide/Open）
- [x] キーマッピングの設定（`<leader>cm`）
- [x] 既存の`claude-cli`との統合（`<leader>ca`連携）
- [x] UIモジュール間の連携（oキーで個別ウィンドウを開く）

### Phase 2: 拡張機能実装

#### 2.1 インスタンス操作機能
- [ ] 新規インスタンスの追加
- [ ] インスタンスの再起動
- [ ] インスタンスの削除
- [ ] インスタンス名の変更

#### 2.2 セッション管理強化
- [ ] セッション永続化
- [ ] 自動復元機能
- [ ] セッション状態の保存

#### 2.3 UI/UX改善
- [ ] ステータス表示（アイドル、処理中等）
- [ ] 最終利用時刻の表示
- [ ] カラーテーマのサポート
- [ ] ヘルプ表示

### Phase 3: 最適化と品質向上

#### 3.1 パフォーマンス最適化
- [ ] バッファの効率的な再利用
- [ ] 非同期処理の活用
- [ ] メモリ使用量の最適化

#### 3.2 エラーハンドリング
- [ ] tmuxコマンドエラーの処理
- [ ] 接続エラーからの復旧
- [ ] ユーザーへの適切な通知

#### 3.3 テストとドキュメント
- [ ] ユニットテストの作成
- [ ] 統合テストの作成
- [ ] ユーザーマニュアルの作成
- [ ] APIドキュメントの整備

## 実装順序とタスク詳細

### Step 1: tmux.lua の実装

```lua
-- 必要な機能:
-- - ensure_session(session_name) -- セッションの存在確認と作成
-- - attach_to_session(session_name, term_buf) -- セッションへのアタッチ
-- - list_sessions() -- 利用可能なセッション一覧
-- - get_session_status(session_name) -- セッションの状態取得
```

### Step 2: ui_list.lua の実装

```lua
-- 必要な機能:
-- - show() -- 一覧画面の表示
-- - hide() -- 一覧画面の非表示
-- - toggle() -- トグル操作
-- - setup_keymaps() -- キーマッピングの設定
-- - create_grid_layout(session_count) -- グリッドレイアウトの作成
```

### Step 3: ui_individual.lua の実装

```lua
-- 必要な機能:
-- - open(session_name) -- 個別ウィンドウを開く
-- - close() -- 個別ウィンドウを閉じる
-- - toggle() -- トグル操作
-- - set_active(session_name) -- アクティブインスタンスの設定
-- - get_active() -- アクティブインスタンスの取得
```

### Step 4: init.lua の更新

```lua
-- 必要な機能:
-- - setup(opts) -- 初期設定
-- - show_list() -- 一覧画面表示コマンド
-- - open_instance(name) -- 個別インスタンスを開く
-- - get_active_instance() -- アクティブインスタンスの取得
```

## 実装上の注意点

1. **既存機能との互換性**
   - 現在の`claude-cli`の機能を壊さない
   - `<leader>ca`との適切な連携

2. **エラーハンドリング**
   - tmuxが利用できない環境での動作
   - セッション作成失敗時の処理

3. **パフォーマンス**
   - 大量のターミナルバッファの効率的な管理
   - 不要なレンダリングの回避

4. **ユーザビリティ**
   - 直感的なキーバインディング
   - 明確なフィードバック

## テスト計画

1. **単体テスト**
   - 各モジュールの個別機能テスト
   - エラーケースのテスト

2. **統合テスト**
   - モジュール間の連携テスト
   - 既存機能との統合テスト

3. **ユーザビリティテスト**
   - 実際の使用シナリオでのテスト
   - パフォーマンステスト

## スケジュール目安

- Phase 1: 2-3日 ✅ **完了（2025年1月4日）**
- Phase 2: 3-4日 （未実装）
- Phase 3: 2-3日 （未実装）

## 実装済み機能のサマリー

### Phase 1で完成した機能：
1. **tmuxベースのマルチインスタンス管理**
   - 最大10個のClaude CLIインスタンスを同時管理
   - 各インスタンスは独立したtmuxセッションで動作

2. **グリッド形式の一覧画面**
   - 新しいタブで全インスタンスをグリッド表示
   - 動的なレイアウト計算（正方形に近い形）
   - トグル機能で表示/非表示の切り替え

3. **個別ウィンドウ管理**
   - 選択したインスタンスを右側の垂直分割で表示
   - アクティブインスタンスの管理と切り替え
   - ウィンドウサイズは画面の40%に自動調整

4. **既存機能との完全な統合**
   - `<leader>ca`でアクティブインスタンスに自動送信
   - 従来の単一インスタンスモードとの互換性維持
   - Vimコマンドによる操作サポート

5. **TDDによる品質保証**
   - 全モジュールにPlenary Bustedによるテスト実装
   - 100%のテストカバレッジ達成

### 次のフェーズで実装予定の機能：
- インスタンスの動的な追加/削除
- セッション永続化と自動復元
- ステータス表示とUI/UXの改善