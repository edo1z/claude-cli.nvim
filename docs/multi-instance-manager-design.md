# Claude CLI Multi-Instance Manager 設計書

## 概要

Claude CLI Multi-Instance Managerは、Neovim内で複数のClaude CLIインスタンスを効率的に管理するためのプラグインです。tmuxセッションを活用して、複数のClaude CLIを同時に起動・管理し、用途に応じて切り替えながら使用できます。

## アーキテクチャ

### tmuxベースの実装

本システムはtmuxを使用して複数のClaude CLIインスタンスを管理します。各インスタンスは独立したtmuxセッションとして動作し、Neovimのターミナルバッファを通じてアクセスされます。

```
┌─────────────────────────────────────────┐
│         Neovim                          │
├─────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────────┐  │
│  │ Manager UI  │  │ Individual UI   │  │
│  │ (List View) │  │ (Active Claude) │  │
│  └──────┬──────┘  └────────┬────────┘  │
│         │                   │           │
│  ┌──────┴──────────────────┴────────┐  │
│  │    Terminal Buffer Manager        │  │
│  └──────────────┬───────────────────┘  │
│                 │                       │
└─────────────────┼───────────────────────┘
                  │
┌─────────────────┴───────────────────────┐
│              tmux Sessions              │
├─────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│ │ claude1 │ │ claude2 │ │ claude3 │   │
│ └─────────┘ └─────────┘ └─────────┘   │
│      ...         ...         ...        │
└─────────────────────────────────────────┘
```

## 主要コンポーネント

### 1. tmuxセッション管理 (`tmux.lua`)

- **セッション作成**: `claude1`から`claude30`までのtmuxセッションを管理
- **セッション確認**: 既存セッションの存在確認と再利用
- **アタッチ管理**: `tmux new-session -A`でセッションへの接続を管理

### 2. 一覧画面UI (`ui_list.lua`)

- **グリッドレイアウト**: 複数のClaude CLIインスタンスをグリッド形式で表示
- **動的レイアウト**: セッション数に応じて最適なグリッドサイズを自動計算
- **キーバインディング**:
  - `o`: 選択したインスタンスを個別ウィンドウで開く
  - `q`: 一覧画面を閉じる
  - `<C-q>`: ターミナルモードから抜ける

### 3. 個別ウィンドウUI (`ui_individual.lua`)

- **アクティブインスタンス管理**: 現在アクティブなClaude CLIインスタンスの管理
- **ウィンドウ配置**: 画面右端に垂直分割で表示（画面幅の40%）
- **トグル機能**: ウィンドウの表示/非表示を切り替え
- **`<leader>ca`との連携**: アクティブなインスタンスへのメッセージ送信

### 4. メインマネージャー (`init.lua`)

- **統合管理**: 各コンポーネントの初期化と連携
- **状態管理**: 現在のアクティブインスタンス、ウィンドウ状態の管理
- **コマンド提供**: ユーザー向けコマンドの定義

## 機能仕様

### 基本機能

1. **動的インスタンス管理**
   - 初期状態：0個（空の一覧画面）
   - 最大30個のClaude CLIインスタンスまで動的に追加可能
   - 各インスタンスは独立したtmuxセッションで動作
   - 不要になったインスタンスの削除機能

2. **一覧表示**
   - 新しいタブでグリッド形式の一覧画面を表示
   - 空の状態から開始し、インスタンスの追加に応じて表示
   - 各セルにClaude CLIインスタンスの状態とオプションを表示
   - トグル操作で表示/非表示の切り替え

3. **インスタンス起動オプション**
   - 通常起動（デフォルト）
   - 継続モード（`-c`オプション）
   - 危険モード（`--dangerously-skip-permissions`）
   - 継続＋危険モード（両オプション）
   - 起動時にオプションを選択可能

4. **個別ウィンドウ**
   - 選択したインスタンスを個別ウィンドウで開く
   - アクティブインスタンスとして設定
   - `<leader>ca`でのメッセージ送信対象となる
   - 個別ウィンドウからのインスタンス削除

5. **キーバインディング（一覧画面）**
   - `a`: 新規インスタンスを追加（通常起動）
   - `A`: 新規インスタンスを追加（オプション選択）
   - `d`: カーソル位置のインスタンスを削除
   - `o`: 個別ウィンドウで開く
   - `r`: インスタンスを再起動
   - `q`: 一覧画面を閉じる
   - `?`: ヘルプ表示

### 拡張機能（将来実装予定）

1. **インスタンス命名**
   - デフォルトの`claude1`等から意味のある名前への変更

2. **セッション永続化**
   - Neovim終了後もtmuxセッションを維持
   - 再起動時の自動復元

3. **ステータス表示**
   - 各インスタンスの状態（アイドル、処理中、エラー等）
   - 最終利用時刻の表示

## 実装の流れ

1. **Phase 1: 基本実装**
   - tmuxセッション管理の実装
   - 一覧画面の表示機能
   - 個別ウィンドウの開閉機能

2. **Phase 2: 統合**
   - `<leader>ca`との連携
   - アクティブインスタンス管理
   - 基本的なインスタンス操作

3. **Phase 3: 拡張機能**
   - インスタンスの追加/削除機能
   - 永続化機能
   - ステータス管理

## 技術的考慮事項

### パフォーマンス

- ターミナルバッファの再利用によるメモリ効率化
- 自動コマンドの適切な管理によるイベント処理の最適化

### 互換性

- tmuxが必要（システム要件）
- 既存の`claude-cli`機能との完全な互換性を維持

### エラーハンドリング

- tmuxコマンドの実行失敗時の適切な処理
- セッション接続エラーの検出と復旧

## 参考実装

本設計は[nvim-tmux-test](https://github.com/edo1z/nvim-tmux-test)の実装を参考にしており、検証済みのアプローチを採用しています。